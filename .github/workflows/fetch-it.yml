name: Update OpenAPI Specification
# This workflow can be triggered manually
on:
  workflow_dispatch:
jobs:
  update-openapi:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch OpenAPI specification
        run: |
          curl -s https://api.vapi.ai/api-json > temp-openapi.json
      
      - name: Verify JSON validity
        run: |
          cat temp-openapi.json | jq . > /dev/null
          if [ $? -ne 0 ]; then
            echo "Error: Invalid JSON received from API endpoint"
            exit 1
          fi
          mv temp-openapi.json ./fern/openapi.json
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet ./fern/openapi.json; then
            echo "No changes detected in OpenAPI specification"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in OpenAPI specification"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup GitHub CLI
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          # Setup branch for changes
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git checkout -b update-openapi-spec
          git add ./fern/openapi.json
          git commit -m "chore: update OpenAPI specification"
          git push -u origin update-openapi-spec
      
      - name: Create Pull Request with GitHub CLI
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          gh pr create \
            --base main \
            --head update-openapi-spec \
            --title "Update OpenAPI Specification" \
            --body "This PR updates the OpenAPI specification from the official Vapi API endpoint.
            
            - Auto-generated by the Update OpenAPI Specification workflow
            - Source: https://api.vapi.ai/api-json
            - Generated at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: PR Result
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "Pull request created successfully!"
      
      - name: No Changes Result
        if: steps.check_changes.outputs.changes_detected == 'false'
        run: |
          echo "No changes detected in OpenAPI specification. No PR created."
